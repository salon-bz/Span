<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Administrador de Publicaciones - SociosXIT</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>

  <style>
    body {
      background: linear-gradient(135deg, #0f172a, #1e293b);
      color: white;
      font-family: "Poppins", sans-serif;
      min-height: 100vh;
      padding: 1.5rem;
    }

    .glass {
      background: rgba(255, 255, 255, 0.07);
      backdrop-filter: blur(18px);
      border-radius: 1.8rem;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: 0.3s;
    }

    .glass:hover {
      transform: translateY(-5px);
      background: rgba(255, 255, 255, 0.1);
    }

    input, textarea {
      background: rgba(255, 255, 255, 0.15);
      border: none;
      border-radius: 1.2rem;
      padding: 0.7rem 1rem;
      color: white;
      outline: none;
      transition: 0.3s;
      width: 100%;
    }

    input:focus, textarea:focus {
      background: rgba(255, 255, 255, 0.25);
      box-shadow: 0 0 10px rgba(59,130,246,0.4);
    }

    .btn {
      border: none;
      border-radius: 2rem;
      padding: 0.6rem 1.2rem;
      font-weight: 600;
      transition: 0.3s;
      cursor: pointer;
    }

    .btn-blue { background: linear-gradient(90deg, #3b82f6, #06b6d4); }
    .btn-red { background: linear-gradient(90deg, #f43f5e, #ef4444); }
    .btn-green { background: linear-gradient(90deg, #10b981, #059669); }

    .preview { border-radius: 1.2rem; overflow: hidden; margin-top: 1rem; }
    video, img { width: 100%; height: 200px; object-fit: cover; }

    .sub-card {
      background: rgba(255,255,255,0.08);
      border-radius: 1rem;
      padding: 1rem;
      margin-top: 1rem;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    /* Nueva regla para organizar mejor los campos dentro de sub-card */
    .sub-card-content {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.75rem; /* Espacio entre los campos de input */
    }
    
    /* Para pantallas medianas, organiza los inputs en dos columnas */
    @media (min-width: 768px) {
        .sub-card-content {
            grid-template-columns: 1fr 1fr;
        }
        .sub-card-content textarea {
            grid-column: span 2; /* Que el textarea ocupe ambas columnas */
        }
    }
  </style>
</head>

<body>
  <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
    <div>
      <h1 class="text-3xl font-bold text-blue-300">üì∞ Administrador de Publicaciones</h1>
      <p class="text-gray-300">Crea, edita o elimina publicaciones del dashboard</p>
    </div>
    <button id="togglePostsBtn" class="btn btn-blue text-lg">
        üìã Ver publicaciones existentes (0)
    </button>
  </header>

  <section class="glass p-8 mb-10">
    <form id="postForm" class="grid gap-5 md:grid-cols-2">
      <div class="flex flex-col gap-1">
        <label for="title" class="font-medium">T√≠tulo</label>
        <input type="text" id="title" placeholder="Ejemplo: Netflix Premium" required />
      </div>

      <div class="flex flex-col gap-1">
        <label for="mediaUrl" class="font-medium">Link de foto o video</label>
        <input type="url" id="mediaUrl" placeholder="https://..." />
      </div>

      <div class="md:col-span-2 mt-2">
        <h3 class="text-lg font-semibold text-blue-300 mb-4 border-b border-gray-700 pb-2">üí∞ Botones de compra</h3>
        <div id="buttonsContainer" class="grid grid-cols-1 gap-4"></div>
        <button type="button" id="addButton" class="btn btn-blue mt-5">‚ûï Agregar otro bot√≥n</button>
      </div>

      <div class="md:col-span-2 flex justify-end mt-6 gap-4">
        <button type="reset" class="btn btn-red" id="cancelBtn">Cancelar</button>
        <button type="submit" class="btn btn-green">üì¢ Publicar</button>
      </div>
    </form>

    <div id="preview" class="preview hidden"></div>
  </section>

  <section id="postSection" class="hidden">
    <h2 class="text-2xl font-semibold text-blue-300 mb-6">üìã Publicaciones existentes</h2>
    <div id="postList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
  </section>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAcbewB4Orpx4JyaXq141GgUidJbXUrEnY",
      authDomain: "sociosxit-5f841.firebaseapp.com",
      databaseURL: "https://sociosxit-5f841-default-rtdb.firebaseio.com",
      projectId: "sociosxit-5f841",
      storageBucket: "sociosxit-5f841.firebasestorage.app",
      messagingSenderId: "364183519851",
      appId: "1:364183519851:web:52a5a95d2c57f8f9f5e72e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const form = document.getElementById("postForm");
    const buttonsContainer = document.getElementById("buttonsContainer");
    const addButton = document.getElementById("addButton");
    const postList = document.getElementById("postList");
    const submitBtn = form.querySelector("button[type='submit']");
    const cancelBtn = document.getElementById("cancelBtn");
    
    // Elementos nuevos para el toggle
    const postSection = document.getElementById("postSection");
    const togglePostsBtn = document.getElementById("togglePostsBtn");

    // Guardamos la funci√≥n de crear original para restaurarla
    let originalSubmitHandler;

    // Funci√≥n para obtener el precio en formato num√©rico (acepta ',' o '.')
    function getPriceValue(inputElement) {
        const priceStr = inputElement.value.trim().replace(',', '.');
        return parseFloat(priceStr);
    }

    // ** Modificaci√≥n de createButtonForm para mejor dise√±o **
    function createButtonForm(index) {
      const div = document.createElement("div");
      div.className = "sub-card";
      div.innerHTML = `
        <div class="flex justify-between items-center mb-4">
          <h4 class="font-semibold text-blue-400">Bot√≥n ${index + 1}</h4>
          <button type="button" class="btn btn-red py-1 px-2 text-sm" onclick="this.parentNode.parentNode.remove()">üóë Eliminar</button>
        </div>
        <div class="sub-card-content">
            <div class="flex flex-col gap-1">
                <label class="text-sm text-gray-400">Texto del bot√≥n</label>
                <input type="text" placeholder="Ej: 1 mes de uso" class="btnText" required />
            </div>
            <div class="flex flex-col gap-1">
                <label class="text-sm text-gray-400">Precio (Ej: 4.70 o 4,70)</label>
                <input type="text" placeholder="Precio" class="btnPrice" required />
            </div>
            <div class="flex flex-col gap-1">
                <label class="text-sm text-gray-400">D√≠as de uso</label>
                <input type="number" placeholder="D√≠as" class="btnDays" required />
            </div>
            <div></div> 
            
            <div class="flex flex-col gap-1 md:col-span-2">
                <label class="text-sm text-gray-400">Claves / Keys</label>
                <textarea placeholder="key: 12345, key: 67890" class="btnKeys" required></textarea>
            </div>
        </div>
      `;
      return div;
    }

    addButton.addEventListener("click", () => {
      buttonsContainer.appendChild(createButtonForm(buttonsContainer.children.length));
    });

    buttonsContainer.appendChild(createButtonForm(0));

    // ** NUEVA FUNCI√ìN: Toggle para ver/ocultar publicaciones **
    togglePostsBtn.addEventListener('click', () => {
        postSection.classList.toggle('hidden');
        const isHidden = postSection.classList.contains('hidden');
        togglePostsBtn.innerHTML = isHidden 
            ? `üìã Ver publicaciones existentes (${postList.children.length})` 
            : `‚ùå Ocultar publicaciones`;
    });
    
    // Funci√≥n que restaura el formulario al estado inicial de "Crear"
    function resetFormState() {
      form.reset();
      buttonsContainer.innerHTML = "";
      buttonsContainer.appendChild(createButtonForm(0));
      
      // Restablecer el bot√≥n de submit
      submitBtn.textContent = "üì¢ Publicar";
      submitBtn.classList.remove("btn-blue");
      submitBtn.classList.add("btn-green");

      // Restaurar el manejador de env√≠o original (Crear)
      if (originalSubmitHandler) {
          form.removeEventListener("submit", form.onsubmit);
          form.addEventListener("submit", originalSubmitHandler);
      }
    }

    // Listener para el bot√≥n Cancelar (resetear la edici√≥n/creaci√≥n)
    cancelBtn.addEventListener("click", (e) => {
        e.preventDefault();
        resetFormState(); 
    });
    
    // Almacenamos el manejador de submit original (Crear)
    originalSubmitHandler = async e => {
      e.preventDefault();

      const title = document.getElementById("title").value.trim();
      const mediaUrl = document.getElementById("mediaUrl").value.trim();

      const buttons = [...buttonsContainer.children].map(div => {
        const text = div.querySelector(".btnText").value.trim();
        const price = getPriceValue(div.querySelector(".btnPrice"));
        const days = parseInt(div.querySelector(".btnDays").value);
        const keysRaw = div.querySelector(".btnKeys").value.trim();
        const keys = keysRaw
          .split(/,|\n/)
          .map(k => {
            const clean = k.trim();
            const match = clean.match(/key\s*:\s*(.+)/i);
            if (match) return { key: match[1].trim() };
          })
          .filter(Boolean);
        return { text, price, days, keys };
      });

      const pub = {
        title,
        mediaUrl,
        buttons,
        createdAt: new Date().toISOString()
      };

      await db.ref("publications").push(pub);
      alert("‚úÖ Publicaci√≥n creada con √©xito");
      resetFormState(); 
    };

    // Crear publicaci√≥n (inicial)
    form.addEventListener("submit", originalSubmitHandler);

    // Mostrar publicaciones
    db.ref("publications").on("value", snap => {
      postList.innerHTML = "";
      const data = snap.val() || {};
      const postCount = Object.keys(data).length;
      
      // Actualizar el contador del bot√≥n
      togglePostsBtn.innerHTML = postSection.classList.contains('hidden') 
          ? `üìã Ver publicaciones existentes (${postCount})` 
          : `‚ùå Ocultar publicaciones`;
      
      Object.keys(data).forEach(id => {
        const p = data[id];
        const media = p.mediaUrl
          ? p.mediaUrl.includes(".mp4")
            ? `<video src="${p.mediaUrl}" controls></video>`
            : `<img src="${p.mediaUrl}" alt="">`
          : "";

        const div = document.createElement("div");
        div.className = "glass p-5";
        div.innerHTML = `
          ${media}
          <h3 class="text-xl font-bold mt-3">${p.title}</h3>
          ${(p.buttons || []).map(b => `
            <div class="mt-3 p-3 rounded-lg bg-gray-800/40">
              <p class="font-semibold text-blue-400">${b.text}</p>
              <p>üí∞ $${b.price} ‚Äî üïí ${b.days} d√≠as</p>
              <p class="text-xs text-gray-400">üîë ${b.keys?.length || 0} claves</p>
            </div>
          `).join("")}
          <button onclick="editPost('${id}')" class="btn btn-blue w-full mt-4">‚úèÔ∏è Editar</button>
          <button onclick="deletePost('${id}')" class="btn btn-red w-full mt-2">üóë Eliminar</button>
        `;
        postList.appendChild(div);
      });
    });

    async function deletePost(id) {
      if (!confirm("¬øSeguro que deseas eliminar esta publicaci√≥n?")) return;
      await db.ref("publications/" + id).remove();
      alert("üóë Publicaci√≥n eliminada correctamente");
    }

    async function editPost(id) {
      const snap = await db.ref("publications/" + id).once("value");
      const pub = snap.val();
      if (!pub) return alert("No encontrada");

      // 1. Cargar datos en el formulario
      document.getElementById("title").value = pub.title;
      document.getElementById("mediaUrl").value = pub.mediaUrl;

      buttonsContainer.innerHTML = "";
      (pub.buttons || []).forEach((b, i) => {
        const div = createButtonForm(i);
        div.querySelector(".btnText").value = b.text;
        div.querySelector(".btnPrice").value = b.price;
        div.querySelector(".btnDays").value = b.days;
        div.querySelector(".btnKeys").value = b.keys.map(k => `key: ${k.key}`).join(", ");
        buttonsContainer.appendChild(div);
      });

      // 2. Modificar la UI del bot√≥n de submit
      submitBtn.textContent = "üíæ Guardar cambios";
      submitBtn.classList.remove("btn-green");
      submitBtn.classList.add("btn-blue");

      // 3. Cambiar el evento de submit temporalmente a 'Guardar'
      form.removeEventListener("submit", originalSubmitHandler);

      // Usamos form.onsubmit para sobrescribir temporalmente el evento
      form.onsubmit = async e => {
        e.preventDefault();
        const title = document.getElementById("title").value.trim();
        const mediaUrl = document.getElementById("mediaUrl").value.trim();

        const buttons = [...buttonsContainer.children].map(div => {
          const text = div.querySelector(".btnText").value.trim();
          const price = getPriceValue(div.querySelector(".btnPrice"));
          const days = parseInt(div.querySelector(".btnDays").value);
          const keysRaw = div.querySelector(".btnKeys").value.trim();
          const keys = keysRaw
            .split(/,|\n/)
            .map(k => {
              const clean = k.trim();
              const match = clean.match(/key\s*:\s*(.+)/i);
              if (match) return { key: match[1].trim() };
            })
            .filter(Boolean);
          return { text, price, days, keys };
        });

        await db.ref("publications/" + id).set({ title, mediaUrl, buttons, createdAt: pub.createdAt });
        
        alert("‚úÖ Publicaci√≥n actualizada");
        resetFormState(); // Vuelve al modo "Crear Publicaci√≥n"
      };
    }
  </script>
</body>
</html>
