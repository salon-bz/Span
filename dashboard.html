
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - SociosXIT</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
  <style>
    /* === TU DISE√ëO ORIGINAL (sin tocar la l√≥gica) === */
    :root{
      --neon-cyan: #00f0ff;
      --neon-pink: #ff4df0;
      --neon-green: #00ff88;
      --neon-yellow: #ffd460;
      --glass-bg: rgba(255,255,255,0.04);
      /* COLORES PARA LA BARRA DE PROGRESO */
      --level-base: rgba(255,255,255,0.1);
      --level-vip: #00f0ff; /* VIP: Cian */
      --level-premium: #ff4df0; /* Premium: Rosa */
    }
  html,body{height:100%;}
  body {
    background: linear-gradient(135deg, #0f0812 10%, #141225 50%, #1b1730 100%);
    min-height: 100vh;
    font-family: 'Poppins', sans-serif;
    position: relative;
    overflow-x: hidden;
    color: #fff;
  }

  /* particles canvas sits behind everything */
  #particles {
    position: fixed;
    inset: 0;
    z-index: 0;
    display: block;
  }

  /* content sits above particles */
  .app-root {
    position: relative;
    z-index: 5;
  }

  .card {
    background: rgba(255,255,255,0.03);
    backdrop-filter: blur(8px);
    border: 1px solid rgba(255,255,255,0.06);
  }

  /* NEON BUTTONS & FLOATING */
  @keyframes floaty {
    0% { transform: translateY(0); }
    50% { transform: translateY(-6px); }
    100% { transform: translateY(0); }
  }

  .neon-btn {
    transition: transform .18s ease, box-shadow .18s ease;
    animation: floaty 3.8s ease-in-out infinite;
    box-shadow: 0 6px 30px rgba(0,0,0,0.35), 0 0 18px rgba(0, 255, 200, 0.06);
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.06);
    backdrop-filter: blur(6px);
  }

  .btn-show {
    background: linear-gradient(90deg, rgba(0,240,255,0.16), rgba(0,122,255,0.14));
    color: var(--neon-cyan);
    box-shadow: 0 6px 26px rgba(0,240,255,0.06), 0 0 14px rgba(0,240,255,0.12);
  }

  .btn-buy {
    background: linear-gradient(90deg, rgba(0,255,136,0.12), rgba(0,184,148,0.14));
    color: var(--neon-green);
    box-shadow: 0 8px 30px rgba(0,255,136,0.06), 0 0 20px rgba(0,255,136,0.08);
  }

  .btn-logout {
    background: linear-gradient(90deg, rgba(255,65,108,0.12), rgba(255,75,43,0.14));
    color: var(--neon-pink);
    box-shadow: 0 8px 30px rgba(255,65,108,0.06), 0 0 20px rgba(255,65,108,0.08);
  }

  /* neon text glows */
  .text-neon-cyan { color: var(--neon-cyan); text-shadow: 0 0 10px rgba(0,240,255,0.18); }
  .text-neon-pink { color: var(--neon-pink); text-shadow: 0 0 10px rgba(255,77,240,0.14); }
  .text-neon-green { color: var(--neon-green); text-shadow: 0 0 10px rgba(0,255,136,0.12); }

  /* pesta√±as */
  .tabs { display:flex; gap:8px; margin-bottom:12px; z-index:6; }
  .tab-btn {
    background: rgba(255,255,255,0.02);
    color: rgba(255,255,255,0.95);
    padding: 8px 14px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,0.04);
    cursor: pointer;
    font-weight: 600;
    transition: transform .12s ease, box-shadow .12s ease;
    box-shadow: 0 6px 18px rgba(0,0,0,0.4);
  }
  .tab-btn.active {
    background: linear-gradient(90deg, rgba(0,240,255,0.14), rgba(59,130,246,0.06));
    color: #061220;
    box-shadow: 0 10px 45px rgba(0,240,255,0.06), 0 0 20px rgba(0,240,255,0.06);
  }

  /* recuadro key */
  .key-box {
    background: rgba(0,0,0,0.45);
    border: 1px solid rgba(0,255,136,0.12);
    padding: 12px;
    border-radius: 12px;
    margin-top: 10px;
  }
  .small-muted { color: rgba(255,255,255,0.75); font-size:0.9rem; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; }

  /* modal */
  .modal-backdrop {
    position: fixed; inset: 0; display: none; align-items: center; justify-content: center;
    background: rgba(0,0,0,0.55); z-index: 1000;
  }
  .modal {
    width: 92%;
    max-width: 520px;
    border-radius: 12px;
    padding: 18px;
    background: rgba(10,8,20,0.7);
    border: 1px solid rgba(255,255,255,0.06);
    backdrop-filter: blur(8px);
    color: white;
    box-shadow: 0 10px 60px rgba(0,0,0,0.7), 0 0 40px rgba(0,240,255,0.04) inset;
  }
  .modal .actions { display:flex; gap:10px; justify-content:flex-end; margin-top:12px; }
  .price-badge { font-size: 1.5rem; font-weight:700; color: var(--neon-yellow); text-shadow:0 0 12px rgba(255,212,96,0.12); }

  /* === HAMBURGER + SIDEBAR (DERECHA) === */
  .hamburger {
    position: fixed;
    right: 18px; /* moved to right */
    top: 18px;
    z-index: 120;
    width: 52px;
    height: 52px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 12px;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border: 1px solid rgba(255,255,255,0.06);
    backdrop-filter: blur(6px);
    cursor: pointer;
    transition: transform .18s ease, background .18s ease;
    box-shadow: 0 8px 30px rgba(0,0,0,0.45);
  }
  .hamburger:active { transform: scale(.98); }

  .burger {
    width: 24px;
    height: 16px;
    position: relative;
    transition: all .25s ease;
  }
  .burger span {
    position: absolute;
    left: 0;
    right: 0;
    height: 2px;
    background: white;
    display: block;
    border-radius: 2px;
    transition: transform .25s ease, opacity .18s ease;
    box-shadow: 0 0 8px rgba(255,255,255,0.06);
  }
  .burger span:nth-child(1) { top: 0; }
  .burger span:nth-child(2) { top: 7px; }
  .burger span:nth-child(3) { top: 14px; }

  /* open / scroll => X */
  .hamburger.open .burger span:nth-child(1) {
    transform: translateY(7px) rotate(45deg);
    background: var(--neon-pink);
    box-shadow: 0 0 18px rgba(255,77,240,0.18);
  }
  .hamburger.open .burger span:nth-child(2) {
    opacity: 0;
  }
  .hamburger.open .burger span:nth-child(3) {
    transform: translateY(-7px) rotate(-45deg);
    background: var(--neon-cyan);
    box-shadow: 0 0 18px rgba(0,240,255,0.18);
  }

  /* backdrop */
  .menu-backdrop {
    position: fixed;
    inset: 0;
    z-index: 110;
    display: none;
    background: rgba(0,0,0,0.55);
    transition: opacity .22s ease;
  }

  /* side menu slides from RIGHT */
  .side-menu {
    position: fixed;
    top: 0;
    right: -100%; /* hidden off-screen to right */
    height: 100vh;
    width: 60vw;
    max-width: 520px;
    z-index: 115;
    padding: 22px;
    display: flex;
    flex-direction: column;
    gap: 14px;
    transition: right .28s cubic-bezier(.2,.9,.2,1);
    border-radius: 12px 0 0 12px;
    background: linear-gradient(180deg, rgba(16,12,28,0.75), rgba(16,12,28,0.6));
    border: 1px solid rgba(255,255,255,0.04);
    backdrop-filter: blur(14px);
    box-shadow: 0 10px 60px rgba(0,0,0,0.7);
  }
  .side-menu.open { right: 0; }

  .menu-user {
    display: flex;
    gap: 12px;
    align-items: center;
  }
  .menu-user .avatar {
    width: 56px; height: 56px; border-radius: 12px;
    background: linear-gradient(90deg,var(--neon-cyan),var(--neon-pink));
    display:flex; align-items:center; justify-content:center; font-weight:700; color:#071122;
    box-shadow: 0 8px 30px rgba(0,240,255,0.06), 0 0 28px rgba(255,77,240,0.06);
    font-size:18px;
  }
  .menu-item {
    display:flex; justify-content:space-between; align-items:center;
    padding:12px; border-radius:12px; cursor:pointer;
    background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border:1px solid rgba(255,255,255,0.03);
    transition: transform .12s ease, background .12s ease, box-shadow .12s ease;
    box-shadow: 0 6px 22px rgba(0,0,0,0.4);
  }
  .menu-item:hover {
    transform: translateX(-6px);
    background: linear-gradient(90deg, rgba(0,240,255,0.03), rgba(255,77,240,0.02));
    box-shadow: 0 10px 45px rgba(0,240,255,0.04), 0 0 18px rgba(255,77,240,0.03);
  }

  /* responsive */
  @media (max-width: 520px) {
    .side-menu { width: 80vw; max-width: none; }
  }

  /* === HIDING main screen controls (we keep markup but hide them visually on main) === */
  /* NOTE: Removed .hide-on-main .tabs from here so the tabs remain visible on main screen. */
  .hide-on-main .user-block,
  .hide-on-main .header-right {
    display: none !important;
  }

  /* small neon touches for cards */
  .card.rounded-xl { border-radius: 14px; box-shadow: 0 8px 40px rgba(0,0,0,0.6); }
  .card .text-2xl { text-shadow: 0 0 12px rgba(0,0,0,0.2); }

  /* Make buy CTA look neon inside the card */
  .btn-buy .py-2 { color: #041020; }

  /* === NUEVOS ESTILOS PARA BARRA DE GASTOS Y NIVEL === */
  .progress-bar {
    height: 8px;
    border-radius: 999px;
    background-color: var(--level-base);
    overflow: hidden;
    margin-top: 4px;
    box-shadow: 0 0 8px rgba(0,0,0,0.3) inset;
  }
  .progress-fill {
    height: 100%;
    width: 0%;
    transition: width 0.4s ease-out, background 0.4s ease;
    background-color: var(--level-base); /* Base, se actualiza por JS */
  }
  .level-label {
    font-weight: 700;
    font-size: 0.9rem;
    text-shadow: 0 0 8px rgba(0,0,0,0.4);
  }
  /* Estilos para nivel VIP */
  .level-vip-text { color: var(--level-vip); text-shadow: 0 0 12px rgba(0,240,255,0.3); }
  /* Estilos para nivel Premium */
  .level-premium-text { color: var(--level-premium); text-shadow: 0 0 12px rgba(255,77,240,0.3); }

  /* Estilo para la barra de progreso en la pantalla principal (opcional: a√±adir margen inferior para separarla de los productos) */
  /* ELIMINADA: #mainLevelBar ya no existe aqu√≠ */
  </style>

</head>
<body class="text-white p-4 md:p-8 hide-on-main">
  <canvas id="particles"></canvas>
  <div class="app-root">
  <div id="hamburgerBtn" class="hamburger" aria-label="Men√∫">
    <div class="burger">
      <span></span><span></span><span></span>
    </div>
  </div>
  <div id="menuBackdrop" class="menu-backdrop"></div>

  <aside id="sideMenu" class="side-menu" aria-hidden="true">
    <div class="menu-user">
      <div class="avatar" id="menuAvatar">UX</div>
      <div>
        <div id="menuUserName" class="font-semibold text-lg text-neon-cyan">Usuario</div>
        <div id="menuUserBalance" class="small-muted mt-1">Saldo: $0.00</div>
      </div>
    </div>
    <div style="height:8px;"></div>
    <div class="card p-3 rounded-lg border-white/5">
        <div class="flex justify-between items-center mb-1">
            <div id="userLevelTextMenu" class="level-label">Nivel: Base</div>
            <div id="levelProgressTextMenu" class="small-muted text-xs">$0.00 / $50.00</div>
        </div>
        <div class="progress-bar">
            <div id="levelProgressBarMenu" class="progress-fill" style="width: 0%;"></div>
        </div>
        <div id="levelNextGoalMenu" class="small-muted text-xs mt-1">
            Pr√≥x. nivel (VIP): $50.00 (10% Desc.)
        </div>
    </div>
    <div style="height:8px;"></div>
    
    <div id="menuRango" class="menu-item neon-btn">
      <div class="text-neon-cyan">üèÜ Ver mi Rango</div>
      <div class="small-muted">Abrir</div>
    </div>

    <div id="menuPublicaciones" class="menu-item neon-btn">
      <div class="text-neon-pink">üì¶ Publicaciones</div>
      <div class="small-muted">Ir</div>
    </div>
    <div id="menuKeys" class="menu-item neon-btn">
      <div class="text-neon-green">üîë Mis Keys</div>
      <div class="small-muted">Historial</div>
    </div>
    <div id="menuLogout" class="menu-item neon-btn">
      <div class="text-neon-pink">üö™ Cerrar sesi√≥n</div>
      <div class="small-muted">Salir</div>
    </div>
    <div style="flex:1"></div>
    <div class="small-muted text-xs">SociosXIT ‚Ä¢ Men√∫</div>
    </aside>
    <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 p-4 rounded-lg card">
      <div class="user-block">
        <h1 class="text-2xl font-bold">Bienvenido, <span id="userName" class="text-blue-300"></span></h1>
        <p class="text-sm text-gray-300">Publicaciones disponibles para ti</p>
        <p class="text-lg mt-2">üí∞ Saldo: <span id="userBalance" class="font-bold text-green-400">$0.00</span> USD</p>
      </div>
      <div class="header-right">
        <button id="showRankBtn" class="btn-show neon-btn font-semibold py-2 px-4 rounded-lg transition-transform hover:scale-105 mr-3">
          Ver mi Rango üèÜ
        </button>
        <button id="logoutBtn" class="btn-logout neon-btn font-semibold py-2 px-4 rounded-lg transition-transform hover:scale-105">
          Cerrar Sesi√≥n
        </button>
      </div>
    </header>
    <div class="tabs">
      <button id="tabPublicaciones" class="tab-btn active neon-btn">üì¶ Publicaciones</button>
      <button id="tabKeys" class="tab-btn neon-btn">üîë Mis Keys</button>
    </div>
    
    <main id="publicationsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></main>

    <section id="myKeysContainer" class="hidden">
      <h2 class="text-xl font-semibold mb-4">üîí Historial de Keys compradas</h2>

      <div class="flex flex-col md:flex-row gap-3 mb-4">
        <input id="searchKeyInput" type="text" placeholder="üîç Buscar por nombre o clave..."
        class="w-full md:w-1/2 px-3 py-2 rounded-lg bg-gray-800 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-400 placeholder-gray-400">

        <select id="filterDateSelect" class="px-3 py-2 rounded-lg bg-gray-800 text-white border border-gray-600 focus:ring-2 focus:ring-blue-400">
          <option value="all">üìÖ Todos</option>
          <option value="today">Hoy</option>
          <option value="7days">√öltimos 7 d√≠as</option>
          <option value="month">Este mes</option>
        </select>
      </div>
      <div id="myKeysList" class="grid grid-cols-1 gap-4"></div>
    </section>
    
    <div id="confirmModal" class="modal-backdrop">
      <div class="modal">
        <div id="confirmContent">
          <div class="text-lg font-semibold mb-2 text-neon-yellow">Confirmar compra</div>
          <div id="confirmText" class="small-muted">¬øDeseas comprar esta key?</div>
          <div id="finalPriceDisplay" class="text-xl font-bold mt-2"></div>
        </div>
        <div class="actions">
          <button id="confirmCancel" class="py-2 px-4 rounded-lg border border-white/10">Cancelar</button>
          <button id="confirmOk" class="py-2 px-4 rounded-lg bg-green-500 font-semibold neon-btn">Comprar</button>
        </div>
      </div>
    </div>
    <div id="keyModal" class="modal-backdrop">
      <div class="modal">
        <div class="text-lg font-semibold mb-2 text-neon-cyan">Clave entregada</div>
        <div id="keyModalContent" class="small-muted">Aqu√≠ va la clave</div>
        <div class="actions">
          <button id="keyCopyBtn" class="py-2 px-4 rounded-lg bg-white text-blue-900 font-semibold">Copiar</button>
          <button id="keyCloseBtn" class="py-2 px-4 rounded-lg border border-white/10">Cerrar</button>
        </div>
      </div>
    </div>
    
  </div><script>
    /* ===================== PARTICLES NEON (lightweight) ===================== */
    (function(){
      const canvas = document.getElementById('particles');
      const ctx = canvas.getContext('2d');
      let w = canvas.width = innerWidth;
      let h = canvas.height = innerHeight;
      const colors = [
        'rgba(0,240,255,0.95)',
        'rgba(255,77,240,0.95)',
        'rgba(0,255,136,0.95)',
        'rgba(255,212,96,0.95)'
      ];
      const particles = [];
      const PARTICLE_COUNT = Math.floor((w*h) / 80000) + 30; // scaled by screen
      function rand(min,max){return Math.random()*(max-min)+min;}
      function makeParticle(){
        return {
          x: rand(0,w),
          y: rand(0,h),
          vx: rand(-0.3,0.3),
          vy: rand(-0.15,0.15),
          r: rand(0.7,2.6),
          life: rand(60,240),
          hue: colors[Math.floor(Math.random()*colors.length)],
          glow: rand(6,18)
        };
      }
      for(let i=0;i<PARTICLE_COUNT;i++) particles.push(makeParticle());
  function resize(){
    w = canvas.width = innerWidth;
    h = canvas.height = innerHeight;
  }
  addEventListener('resize', ()=>{ resize(); });
  function draw(){
    ctx.clearRect(0,0,w,h);
    // subtle background radial gradient for depth
    const g = ctx.createLinearGradient(0,0,w,h);
    g.addColorStop(0, 'rgba(10,8,20,0.0)');
    g.addColorStop(1, 'rgba(6,4,12,0.12)');
    ctx.fillStyle = g;
    ctx.fillRect(0,0,w,h);

    // draw particles
    for(let p of particles){
      // move
      p.x += p.vx;
      p.y += p.vy;
      p.life--;
      if(p.x < -20) p.x = w+20;
      if(p.x > w+20) p.x = -20;
      if(p.y < -20) p.y = h+20;
      if(p.y > h+20) p.y = -20;
      if(p.life <= 0){
        Object.assign(p, makeParticle());
        p.x = rand(0,w);
        p.y = rand(0,h);
      }

      // glow
      ctx.beginPath();
      const grd = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.glow);
      grd.addColorStop(0, p.hue);
      grd.addColorStop(0.15, p.hue.replace('1)', '0.35)'));
      grd.addColorStop(0.6, p.hue.replace('1)', '0.08)'));
      grd.addColorStop(1, 'rgba(0,0,0,0)');
      ctx.fillStyle = grd;
      ctx.arc(p.x, p.y, p.r*3 + (p.glow/6), 0, Math.PI*2);
      ctx.fill();
    }

    // connect close particles gently
    ctx.lineWidth = 0.6;
    for(let i=0;i<particles.length;i++){
      for(let j=i+1;j<particles.length && j<i+4;j++){
        const a=particles[i], b=particles[j];
        const dx=a.x-b.x, dy=a.y-b.y;
        const d2 = dx*dx+dy*dy;
        if(d2 < 25000){
          const alpha = 1 - d2/25000;
          ctx.strokeStyle = 'rgba(120,200,255,'+ (alpha*0.06) +')';
          ctx.beginPath();
          ctx.moveTo(a.x,a.y);
          ctx.lineTo(b.x,b.y);
          ctx.stroke();
        }
      }
    }

    requestAnimationFrame(draw);

  }
  resize();
  draw();
  })();

/* ===================== REST OF APP (YOUR LOGIC + NEW LEVEL LOGIC) ===================== */

// --- Firebase Configuraci√≥n (unchanged) ---
const firebaseConfig = {
  apiKey: "AIzaSyAcbewB4Orpx4JyaXq141GgUidJbXUrEnY",
  authDomain: "sociosxit-5f841.firebaseapp.com",
  databaseURL: "https://sociosxit-5f841-default-rtdb.firebaseio.com",
  projectId: "sociosxit-5f841",
  storageBucket: "sociosxit-5f841.firebasestorage.app",
  messagingSenderId: "364183519851",
  appId: "1:364183519851:web:52a5a95d2c57f8f9f5e72e"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const pubsRef = db.ref("publications");

// UI elements (existing)
const userNameEl = document.getElementById("userName");
const userBalanceEl = document.getElementById("userBalance");
const logoutBtn = document.getElementById("logoutBtn");
const publicationsContainer = document.getElementById("publicationsContainer");
const myKeysList = document.getElementById("myKeysList");
const myKeysContainer = document.getElementById("myKeysContainer");

// menu elements (new)
const hamburgerBtn = document.getElementById("hamburgerBtn");
const sideMenu = document.getElementById("sideMenu");
const menuBackdrop = document.getElementById("menuBackdrop");
const menuUserName = document.getElementById("menuUserName");
const menuUserBalance = document.getElementById("menuUserBalance");
const menuAvatar = document.getElementById("menuAvatar");
const menuPublicaciones = document.getElementById("menuPublicaciones");
const menuKeys = document.getElementById("menuKeys");
const menuLogout = document.getElementById("menuLogout");
const menuRango = document.getElementById("menuRango"); // NUEVO

// existing modals
const confirmModal = document.getElementById("confirmModal");
const confirmText = document.getElementById("confirmText");
const confirmOk = document.getElementById("confirmOk");
const confirmCancel = document.getElementById("confirmCancel");
const keyModal = document.getElementById("keyModal");
const keyModalContent = document.getElementById("keyModalContent");
const keyCopyBtn = document.getElementById("keyCopyBtn");
const keyCloseBtn = document.getElementById("keyCloseBtn");

// NEW elements for level/progress bar
const finalPriceDisplay = document.getElementById("finalPriceDisplay"); // Added to modal

// ELEMENTS FOR MENU BAR (RENAMED to avoid conflict)
const userLevelTextMenu = document.getElementById("userLevelTextMenu");
const levelProgressTextMenu = document.getElementById("levelProgressTextMenu");
const levelProgressBarMenu = document.getElementById("levelProgressBarMenu");
const levelNextGoalMenu = document.getElementById("levelNextGoalMenu");

// Tabs (existing)
const tabPublicaciones = document.getElementById("tabPublicaciones");
const tabKeys = document.getElementById("tabKeys");

// NUEVO BOT√ìN PARA ABRIR RANGO.HTML
const showRankBtn = document.getElementById("showRankBtn");

// --- Tabs functions (unchanged) ---
tabPublicaciones.onclick = () => showTab("pubs");
tabKeys.onclick = () => showTab("keys");
function showTab(tab) {
  if (tab === "pubs") {
    publicationsContainer.classList.remove("hidden");
    myKeysContainer.classList.add("hidden");
    tabPublicaciones.classList.add("active");
    tabKeys.classList.remove("active");
  } else {
    publicationsContainer.classList.add("hidden");
    myKeysContainer.classList.remove("hidden");
    tabPublicaciones.classList.remove("active");
    tabKeys.classList.add("active");
  }
}

// --- Session (unchanged) ---
const currentUser = sessionStorage.getItem("sociosxit_user");
if (!currentUser) window.location.href = "index.html";
else {
  userNameEl.textContent = currentUser;
  loadUserBalance(currentUser);
  loadUserPurchases(currentUser);
  loadUserSpendingAndLevel(currentUser); // NEW: Load spending and level
  // also set menu values
  menuUserName.textContent = currentUser;
  menuAvatar.textContent = String(currentUser).charAt(0)?.toUpperCase() || "U";
}

logoutBtn.onclick = () => {
  sessionStorage.removeItem("sociosxit_user");
  window.location.href = "index.html";
};

// --- Manejo del bot√≥n de Rango ---
function goToRankPage() {
  // Guardamos el usuario actual en el sessionStorage para que rango.html lo use
  sessionStorage.setItem("current_rank_user", currentUser);
  window.location.href = "rango.html";
}

showRankBtn.addEventListener("click", goToRankPage);
menuRango.addEventListener("click", goToRankPage);
// --- Fin Manejo del bot√≥n de Rango ---


// menu interactions (open from RIGHT)
function openMenu() {
  sideMenu.classList.add("open");
  menuBackdrop.style.display = "block";
  setTimeout(()=> menuBackdrop.style.opacity = "1", 10);
  hamburgerBtn.classList.add("open");
  sideMenu.setAttribute("aria-hidden", "false");
  // menuUserBalance updated by loadUserBalance listener
}
function closeMenu() {
  sideMenu.classList.remove("open");
  menuBackdrop.style.opacity = "0";
  hamburgerBtn.classList.remove("open");
  sideMenu.setAttribute("aria-hidden", "true");
  setTimeout(()=> menuBackdrop.style.display = "none", 240);
}

hamburgerBtn.addEventListener("click", ()=> {
  if (sideMenu.classList.contains("open")) closeMenu();
  else openMenu();
});

// close when clicking backdrop
menuBackdrop.addEventListener("click", closeMenu);

// change hamburger into X on scroll (as requested) - style only
window.addEventListener("scroll", () => {
  const px = window.scrollY || document.documentElement.scrollTop;
  if (px > 20) hamburgerBtn.classList.add("open");
  else {
    // don't remove open if menu is open
    if (!sideMenu.classList.contains("open")) hamburgerBtn.classList.remove("open");
  }
});

// menu item behavior (navigate tabs + close)
menuPublicaciones.addEventListener("click", ()=> { showTab("pubs"); closeMenu(); });
menuKeys.addEventListener("click", ()=> { showTab("keys"); closeMenu(); });
menuLogout.addEventListener("click", ()=> {
  sessionStorage.removeItem("sociosxit_user");
  window.location.href = "index.html";
});

// --- Publicaciones (unchanged logic) ---
pubsRef.on("value", (snapshot) => {
  publicationsContainer.innerHTML = "";
  const data = snapshot.val();
  if (!data) {
    publicationsContainer.innerHTML = "<p>No hay publicaciones disponibles.</p>";
    return;
  }
  Object.keys(data).forEach(key => {
    const pub = data[key];
    publicationsContainer.prepend(createPublicationElement(pub, key));
  });
});

// create publication card (keeps your exact design)
function createPublicationElement(pub, key) {
  const div = document.createElement("div");
  div.className = "card rounded-xl overflow-hidden shadow-lg p-5";

  let mediaHTML = "";
  if (pub.mediaUrl) {
    if (pub.mediaUrl.includes("youtube.com") || pub.mediaUrl.includes("youtu.be")) {
      const videoId = pub.mediaUrl.split('v=')[1] || pub.mediaUrl.split('/').pop();
      mediaHTML = `<div class="aspect-w-16 aspect-h-9 mb-4"><iframe src="https://www.youtube.com/embed/${videoId}" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen class="w-full h-full rounded-lg"></iframe></div>`;
    } else {
      mediaHTML = `<img src="${pub.mediaUrl}" alt="${pub.title}" class="w-full h-48 object-cover rounded-lg mb-4">`;
    }
  }

  // buttons area: transform the info block into a clickable buy button
  let buttonsHTML = "";
  if (pub.buttons) {
    Object.keys(pub.buttons).forEach(btnKey => {
      const btn = pub.buttons[btnKey];
      // price as decimal with two places
      const priceNum = parseFloat(btn.price || 0);
      const price = Number.isFinite(priceNum) ? priceNum.toFixed(2) : "0.00";
      const duration = btn.duration || (btn.days ? `${btn.days} d√≠as` : "");
      const keysCount = countKeys(btn.keys);

      // safe id for DOM
      const safeBtnId = String(btnKey).replace(/\W/g, "_");
      // onclick will open confirm modal and pass publish id + btnKey
      buttonsHTML += `
        <div class="btn-buy neon-btn p-4 rounded-lg text-center transition-transform hover:scale-105 cursor-pointer mb-3">
          <button onclick="openConfirmModal('${key}','${safeBtnId}', ${priceNum}, '${btnKey}')" class="w-full text-left">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-2xl font-bold text-neon-cyan">$${price}</div>
                <div class="text-sm font-semibold text-neon-pink">${duration || '‚Äî'}</div>
                <div class="text-xs small-muted mt-1">üîë ${keysCount} claves disponibles</div>
              </div>
              <div>
                <div class="py-2 px-3 rounded-full bg-white text-blue-900 font-bold">Comprar</div>
              </div>
            </div>
          </button>
        </div>`;
    });
  }

  div.innerHTML = `${mediaHTML}<h2 class="text-2xl font-bold mb-3 text-neon-pink">${pub.title}</h2><button class="btn-show neon-btn w-full py-2 rounded-lg font-semibold mb-3" onclick="toggleDetails('${key}')">Mostrar Opciones</button><div id="details-${key}" class="hidden mt-4 space-y-3">${buttonsHTML || "<p class='text-gray-400'>Sin botones disponibles</p>"}</div>`;
  return div;
}

function toggleDetails(key) {
  const el = document.getElementById(`details-${key}`);
  if (el) el.classList.toggle("hidden");
}

// --- Helpers for keys parsing + counting (unchanged) ---
function countKeys(keysField) {
  if (!keysField) return 0;
  if (Array.isArray(keysField)) return keysField.length;
  if (typeof keysField === "string") {
    return keysField.split(",").map(s => s.trim()).filter(Boolean).length;
  }
  return 0;
}

// ===============================
// MODAL DE CONFIRMACI√ìN DE COMPRA
// ===============================
const confirmModal = document.createElement("div");
confirmModal.className = "fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50";
confirmModal.innerHTML = `
  <div class="bg-gray-900 text-white rounded-2xl p-6 w-80 shadow-2xl border border-purple-600">
    <h2 class="text-xl font-bold mb-3 text-center text-purple-400">Confirmar compra</h2>
    <p id="confirmMessage" class="text-center mb-6 text-gray-300"></p>
    <div class="flex justify-center gap-4">
      <button id="confirmCancel" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm">Cancelar</button>
      <button id="confirmOk" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-sm">Confirmar</button>
    </div>
  </div>
`;
document.body.appendChild(confirmModal);

const confirmMessage = document.getElementById("confirmMessage");
const confirmCancel = document.getElementById("confirmCancel");
const confirmOk = document.getElementById("confirmOk");

confirmCancel.onclick = () => {
  confirmModal.classList.add("hidden");
};

let pendingPurchase = null; // Guarda la compra actual antes de confirmar

// ===============================
// FUNCI√ìN PARA ABRIR MODAL DE CONFIRMACI√ìN
// ===============================
function openConfirmModal(pubId, btnKeyIdentifier, btn) {
  confirmMessage.textContent = "¬øDeseas confirmar esta compra?";
  confirmModal.classList.remove("hidden");
  pendingPurchase = { pubId, btnKeyIdentifier, btn };
}

// ===============================
// ACCI√ìN AL CONFIRMAR COMPRA
// ===============================
confirmOk.onclick = async () => {
  if (!pendingPurchase) return;
  const { pubId, btnKeyIdentifier, btn } = pendingPurchase;

  confirmModal.classList.add("hidden");
  btn.disabled = true;
  btn.textContent = "Procesando...";

  try {
    // Simula obtener las keys de Firebase o localStorage
    let pubs = JSON.parse(localStorage.getItem("publicaciones")) || [];
    let pub = pubs.find(p => p.id === pubId);
    if (!pub) throw new Error("Publicaci√≥n no encontrada");

    let keys = parseKeysField(pub.keys);
    let availableKey = keys.find(k => !k.usada);

    if (!availableKey) {
      alert("No hay claves disponibles para esta publicaci√≥n.");
      btn.disabled = false;
      btn.textContent = "Comprar";
      return;
    }

    // Marcar key como usada
    availableKey.usada = true;
    pub.keys = keys;

    // Guardar cambios
    localStorage.setItem("publicaciones", JSON.stringify(pubs));

    // Simula entrega de clave
    setTimeout(() => {
      alert(`‚úÖ Compra completada.\nTu clave es:\n${availableKey.key}`);
      btn.textContent = "Comprado ‚úÖ";
      btn.classList.remove("bg-purple-600", "hover:bg-purple-700");
      btn.classList.add("bg-green-600", "cursor-not-allowed");
    }, 800);

  } catch (error) {
    console.error(error);
    alert("Error al procesar la compra.");
    btn.disabled = false;
    btn.textContent = "Comprar";
  }

  pendingPurchase = null;
};

// ===============================
// ASIGNAR EVENTOS DE COMPRA A BOTONES
// ===============================
function initBuyButtons() {
  document.querySelectorAll(".btn-comprar").forEach(btn => {
    btn.onclick = () => {
      const pubId = btn.getAttribute("data-pubid");
      const keyId = btn.getAttribute("data-keyid");
      openConfirmModal(pubId, keyId, btn);
    };
  });
}

// Inicializa los botones al cargar
document.addEventListener("DOMContentLoaded", initBuyButtons);

// --- NEW: Level and Discount Logic (Exported for Rango.html) ---
const LEVEL_VIP_SPEND = 50;
const LEVEL_PREMIUM_SPEND = 150;
let userTotalSpending = 0; // Global variable to store current spending

/**
 * Calculates the user's current level and discount based on total spending.
 * @param {number} spending - The user's total accumulated spending.
 * @returns {{level: string, discount: number, nextGoal: number, goalLabel: string, progressColor: string}}
 */
function calculateLevel(spending) {
  if (spending >= LEVEL_PREMIUM_SPEND) {
    return {
      level: "Premium",
      discount: 0.20, // 20%
      nextGoal: LEVEL_PREMIUM_SPEND,
      goalLabel: "¬°Nivel M√°ximo!",
      progressColor: "var(--level-premium)"
    };
  } else if (spending >= LEVEL_VIP_SPEND) {
    return {
      level: "VIP",
      discount: 0.10, // 10%
      nextGoal: LEVEL_PREMIUM_SPEND,
      goalLabel: `Pr√≥x. nivel (Premium): $${LEVEL_PREMIUM_SPEND.toFixed(2)} (20% Desc.)`,
      progressColor: "var(--level-vip)"
    };
  } else {
    return {
      level: "Base",
      discount: 0.00, // 0%
      nextGoal: LEVEL_VIP_SPEND,
      goalLabel: `Pr√≥x. nivel (VIP): $${LEVEL_VIP_SPEND.toFixed(2)} (10% Desc.)`,
      progressColor: "var(--level-base)"
    };
  }
}

/**
 * Updates the level bar UI (only menu in this file).
 * @param {number} spending - The user's total accumulated spending.
 * @param {boolean} isMenu - Always true in this file, but kept for clarity.
 */
function updateLevelUI(spending, isMenu = true) {
  const { level, discount, nextGoal, goalLabel, progressColor } = calculateLevel(spending);

  userTotalSpending = spending; // Update global spending

  // --- Logic for Menu Bar only ---
  if (isMenu) {
    const bar = {
      userLevelText: userLevelTextMenu,
      levelProgressText: levelProgressTextMenu,
      levelProgressBar: levelProgressBarMenu,
      levelNextGoal: levelNextGoalMenu
    };

    if (!bar.userLevelText) return;

    bar.userLevelText.textContent = `Nivel: ${level}`;
    bar.userLevelText.className = `level-label ${level === 'VIP' ? 'level-vip-text' : level === 'Premium' ? 'level-premium-text' : ''}`;
    bar.levelNextGoal.textContent = goalLabel;

    let percentage = 0;
    let goalAmount = 0;

    if (spending < LEVEL_VIP_SPEND) {
      goalAmount = LEVEL_VIP_SPEND;
      percentage = (spending / goalAmount) * 100;
      bar.levelProgressText.textContent = `$${spending.toFixed(2)} / $${goalAmount.toFixed(2)}`;
    } else if (spending < LEVEL_PREMIUM_SPEND) {
      goalAmount = LEVEL_PREMIUM_SPEND;
      percentage = ((spending - LEVEL_VIP_SPEND) / (LEVEL_PREMIUM_SPEND - LEVEL_VIP_SPEND)) * 100; // Progress from VIP to Premium
      if (percentage > 100) percentage = 100; // Should not happen with correct data
      
      bar.levelProgressText.textContent = `$${spending.toFixed(2)} / $${LEVEL_PREMIUM_SPEND.toFixed(2)}`;
    } else {
      percentage = 100;
      bar.levelProgressText.textContent = `¬°Nivel M√°ximo! ($${spending.toFixed(2)})`;
    }

    bar.levelProgressBar.style.width = `${Math.min(percentage, 100).toFixed(2)}%`;
    bar.levelProgressBar.style.backgroundColor = progressColor;
  }
  // The original updateLevelUI function's logic for the main bar is now removed/omitted
}

/**
 * Loads the user's total accumulated spending in real-time.
 */
function loadUserSpendingAndLevel(email) {
  const userKey = sanitizeEmail(email);
  const purchasesRef = db.ref(`users/${userKey}/purchases`);

  purchasesRef.on("value", snap => {
    const purchases = snap.val();
    let totalSpent = 0;
    if (purchases) {
      Object.values(purchases).forEach(p => {
        // Price saved in history is the ACTUAL PRICE PAID
        totalSpent += parseFloat(p.price || 0); 
      });
    }
    
    // Update only the menu bar (isMenu=true by default)
    updateLevelUI(totalSpent, true); 
  });
}

// --- Confirm modal flow (unchanged) ---
let _pendingPurchase = null; 

function openConfirmModal(pubId, safeBtnId, price, rawBtnId) {
  // Function body is long, omitting for brevity in response but should be kept
  // in your actual file to maintain functionality.
}

confirmCancel.onclick = () => {
  confirmModal.style.display = "none";
  _pendingPurchase = null;
};
confirmOk.onclick = async () => {
  if (!_pendingPurchase) return;
  confirmModal.style.display = "none";
  await comprarKey(_pendingPurchase.pubId, _pendingPurchase.safeBtnId, _pendingPurchase.price, _pendingPurchase.rawBtnId, _pendingPurchase.finalPrice);
  _pendingPurchase = null;
};

// --- Main purchase function (unchanged) ---
async function comprarKey(pubId, safeBtnId, originalPrice, rawBtnId, finalPrice) {
  // Function body is long, omitting for brevity in response but should be kept
  // in your actual file to maintain functionality.
}

// --- sanitize email (unchanged) ---
function sanitizeEmail(email) {
  return email.replace(/\./g, "_");
}

// --- load user balance (real-time) (unchanged) ---
function loadUserBalance(email) {
  // Function body is long, omitting for brevity in response but should be kept
  // in your actual file to maintain functionality.
}

// --- Historial (Mis Keys) with search & filter (unchanged) ---
function loadUserPurchases(email) {
  // Function body is long, omitting for brevity in response but should be kept
  // in your actual file to maintain functionality.
}

function copiarKey(text) {
  navigator.clipboard.writeText(text).then(() => alert("üîë Clave copiada al portapapeles."));
}

// show publications by default
showTab("pubs");

</script>
</body>
</html>
