<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - SociosXIT</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>

  <style>
    body {
      background: linear-gradient(135deg, #232526, #414345);
      min-height: 100vh;
      font-family: 'Poppins', sans-serif;
    }
    .card {
      background: rgba(255,255,255,0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
    }
    .btn-show { background: linear-gradient(90deg, #00c6ff, #0072ff); }
    .btn-buy {
      background: linear-gradient(90deg, #00ff88, #00b894);
      border: 1px solid rgba(255,255,255,0.2);
    }
    .btn-logout { background: linear-gradient(90deg, #ff416c, #ff4b2b); }

    .tabs { display:flex; gap:8px; margin-bottom:12px; }
    .tab-btn {
      background: rgba(255,255,255,0.03);
      color: rgba(255,255,255,0.9);
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.06);
      cursor: pointer;
      font-weight: 600;
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .tab-btn.active {
      background: linear-gradient(90deg,#00c6ff,#0072ff);
      color: #0b1020;
      box-shadow: 0 8px 30px rgba(0,198,255,0.12);
      transform: translateY(-2px);
    }
    .modal-backdrop {
      position: fixed; inset: 0; display: none; align-items: center; justify-content: center;
      background: rgba(0,0,0,0.5); z-index: 60;
    }
    .modal {
      width: 92%; max-width: 520px; border-radius: 12px;
      padding: 18px; background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08); backdrop-filter: blur(8px);
      color: white; box-shadow: 0 10px 40px rgba(0,0,0,0.6);
    }
    .price-badge { font-size: 1.5rem; font-weight:700; }
  </style>
</head>

<body class="text-white p-4 md:p-8">
  <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 p-4 rounded-lg card">
    <div>
      <h1 class="text-2xl font-bold">Bienvenido, <span id="userName" class="text-blue-300"></span></h1>
      <p class="text-sm text-gray-300">Publicaciones disponibles para ti</p>
      <p class="text-lg mt-2">游눯 Saldo: <span id="userBalance" class="font-bold text-green-400">$0.00</span> USD</p>
    </div>
    <div class="mt-4 md:mt-0 flex items-center gap-3">
      <button id="logoutBtn" class="btn-logout font-semibold py-2 px-4 rounded-lg transition-transform hover:scale-105">Cerrar Sesi칩n</button>
    </div>
  </header>

  <!-- 游댫 Nivel de Usuario -->
  <section id="progressSection" class="card p-4 mb-6 rounded-lg text-center">
    <h2 id="rankText" class="text-lg font-semibold mb-2">Nivel 1</h2>
    <div class="w-full bg-gray-700 rounded-full h-4 overflow-hidden">
      <div id="rankBar" class="h-4 rounded-full transition-all duration-700"></div>
    </div>
    <p id="progressText" class="text-sm text-gray-300 mt-2">Has gastado $0 / $10</p>
  </section>

  <!-- pesta침as -->
  <div class="tabs">
    <button id="tabPublicaciones" class="tab-btn active">游닍 Publicaciones</button>
    <button id="tabKeys" class="tab-btn">游댐 Mis Keys</button>
  </div>

  <!-- publicaciones -->
  <main id="publicationsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></main>
  <section id="myKeysContainer" class="hidden">
    <h2 class="text-xl font-semibold mb-4">游 Historial de Keys compradas</h2>
    <div id="myKeysList" class="grid grid-cols-1 gap-4"></div>
  </section>

  <!-- modales -->
  <div id="confirmModal" class="modal-backdrop">
    <div class="modal">
      <div class="text-lg font-semibold mb-2">Confirmar compra</div>
      <div id="confirmText" class="small-muted">쮻eseas comprar esta key?</div>
      <div class="flex justify-end gap-2 mt-4">
        <button id="confirmCancel" class="py-2 px-4 rounded-lg border border-white/10">Cancelar</button>
        <button id="confirmOk" class="py-2 px-4 rounded-lg bg-green-500 font-semibold">Comprar</button>
      </div>
    </div>
  </div>

  <div id="keyModal" class="modal-backdrop">
    <div class="modal">
      <div class="text-lg font-semibold mb-2">Clave entregada</div>
      <div id="keyModalContent" class="small-muted">Aqu칤 va la clave</div>
      <div class="flex justify-end gap-2 mt-4">
        <button id="keyCopyBtn" class="py-2 px-4 rounded-lg bg-white text-blue-900 font-semibold">Copiar</button>
        <button id="keyCloseBtn" class="py-2 px-4 rounded-lg border border-white/10">Cerrar</button>
      </div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAcbewB4Orpx4JyaXq141GgUidJbXUrEnY",
      authDomain: "sociosxit-5f841.firebaseapp.com",
      databaseURL: "https://sociosxit-5f841-default-rtdb.firebaseio.com",
      projectId: "sociosxit-5f841",
      storageBucket: "sociosxit-5f841.firebasestorage.app",
      messagingSenderId: "364183519851",
      appId: "1:364183519851:web:52a5a95d2c57f8f9f5e72e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const rankBar = document.getElementById("rankBar");
    const rankText = document.getElementById("rankText");
    const progressText = document.getElementById("progressText");
    const currentUser = sessionStorage.getItem("sociosxit_user");

    if (!currentUser) window.location.href = "index.html";
    else updateRank(currentUser);

    // 游꿢 Configuraci칩n de niveles
    const rankLevels = [
      { level: 1, color: "#00b4ff", goal: 10 },
      { level: 2, color: "#00ff88", goal: 30 },
      { level: 3, color: "#ffa500", goal: 60 },
      { level: 4, color: "#b000ff", goal: 100 },
      { level: 5, color: "#ffd700", goal: 150 }
    ];

    // 游 Cargar progreso mensual
    function updateRank(email) {
      const key = email.replace(/\./g, "_");
      const ref = db.ref("users/" + key + "/monthlyProgress");

      ref.once("value", snap => {
        const now = new Date();
        const monthKey = `${now.getFullYear()}-${now.getMonth() + 1}`;
        let data = snap.val() || {};
        if (!data[monthKey]) data[monthKey] = { spent: 0, lastReset: null };

        // Si alcanz칩 el m치ximo nivel y es nuevo mes, reiniciar
        const lastMonthKey = data.lastReset;
        if (lastMonthKey && lastMonthKey !== monthKey && data[monthKey - 1]?.spent >= rankLevels.at(-1).goal) {
          data[monthKey] = { spent: 0, lastReset: monthKey };
        }

        renderRank(data[monthKey].spent);
      });

      // actualizar visual en tiempo real si cambia
      ref.on("value", snap => {
        const now = new Date();
        const monthKey = `${now.getFullYear()}-${now.getMonth() + 1}`;
        const val = snap.val()?.[monthKey]?.spent || 0;
        renderRank(val);
      });
    }

    // 游눯 Actualizar progreso cuando compra
    async function addSpending(email, amount) {
      const key = email.replace(/\./g, "_");
      const ref = db.ref("users/" + key + "/monthlyProgress");
      const now = new Date();
      const monthKey = `${now.getFullYear()}-${now.getMonth() + 1}`;

      const snap = await ref.once("value");
      let data = snap.val() || {};
      if (!data[monthKey]) data[monthKey] = { spent: 0, lastReset: null };

      data[monthKey].spent = (parseFloat(data[monthKey].spent) || 0) + amount;
      await ref.set(data);
    }

    // 游꿛 Render visual del rango
    function renderRank(spent) {
      let level = rankLevels[0];
      for (const l of rankLevels) if (spent >= l.goal) level = l;
      const percent = Math.min((spent / level.goal) * 100, 100);
      rankBar.style.width = percent + "%";
      rankBar.style.background = level.color;
      rankText.textContent = `Nivel ${level.level}`;
      progressText.textContent = `Has gastado $${spent.toFixed(2)} / $${level.goal.toFixed(2)}`;
    }

    // 拘勇 Conecta gasto con compra existente
    const originalComprarKey = window.comprarKey;
    window.comprarKey = async function(pubId, safeBtnId, price, rawBtnId) {
      await originalComprarKey(pubId, safeBtnId, price, rawBtnId);
      await addSpending(currentUser, price);
    };
  </script>
</body>
</html>
