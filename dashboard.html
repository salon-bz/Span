<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - SociosXIT</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>

  <style>
    body {
      background: linear-gradient(135deg, #232526, #414345);
      min-height: 100vh;
      font-family: 'Poppins', sans-serif;
    }
    .card {
      background: rgba(255,255,255,0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
    }
    .btn-show {
      background: linear-gradient(90deg, #00c6ff, #0072ff);
    }
    .btn-buy {
      background: linear-gradient(90deg, #00ff88, #00b894);
      border: 1px solid rgba(255,255,255,0.2);
    }
    .btn-logout {
      background: linear-gradient(90deg, #ff416c, #ff4b2b);
    }

    /* pestaÃ±as */
    .tabs { display:flex; gap:8px; margin-bottom:12px; }
    .tab-btn {
      background: rgba(255,255,255,0.03);
      color: rgba(255,255,255,0.9);
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.06);
      cursor: pointer;
      font-weight: 600;
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .tab-btn.active {
      background: linear-gradient(90deg,#00c6ff,#0072ff);
      color: #0b1020;
      box-shadow: 0 8px 30px rgba(0,198,255,0.12);
      transform: translateY(-2px);
    }

    /* recuadro key */
    .key-box {
      background: rgba(0,0,0,0.45);
      border: 1px solid rgba(0,255,136,0.12);
      padding: 12px;
      border-radius: 12px;
      margin-top: 10px;
    }
    .small-muted { color: rgba(255,255,255,0.7); font-size:0.9rem; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; }
  </style>
</head>

<body class="text-white p-4 md:p-8">
  <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 p-4 rounded-lg card">
    <div>
      <h1 class="text-2xl font-bold">Bienvenido, <span id="userName" class="text-blue-300"></span></h1>
      <p class="text-sm text-gray-300">Publicaciones disponibles para ti</p>
      <p class="text-lg mt-2">ðŸ’° Saldo: <span id="userBalance" class="font-bold text-green-400">$0.00</span> USD</p>
    </div>
    <div class="mt-4 md:mt-0 flex items-center gap-3">
      <button id="logoutBtn" class="btn-logout font-semibold py-2 px-4 rounded-lg transition-transform hover:scale-105">
        Cerrar SesiÃ³n
      </button>
    </div>
  </header>

  <!-- pestaÃ±as -->
  <div class="tabs">
    <button id="tabPublicaciones" class="tab-btn active">ðŸ“¦ Publicaciones</button>
    <button id="tabKeys" class="tab-btn">ðŸ”‘ Mis Keys</button>
  </div>

  <!-- Contenedor Publicaciones -->
  <main id="publicationsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></main>

  <!-- Contenedor Mis Keys -->
  <section id="myKeysContainer" class="hidden">
    <h2 class="text-xl font-semibold mb-4">ðŸ”’ Historial de Keys compradas</h2>

    <!-- Filtros y bÃºsqueda -->
    <div class="flex flex-col md:flex-row gap-3 mb-4">
      <input id="searchKeyInput" type="text" placeholder="ðŸ” Buscar por nombre o clave..." 
        class="w-full md:w-1/2 px-3 py-2 rounded-lg bg-gray-800 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-400 placeholder-gray-400">
      
      <select id="filterDateSelect" class="px-3 py-2 rounded-lg bg-gray-800 text-white border border-gray-600 focus:ring-2 focus:ring-blue-400">
        <option value="all">ðŸ“… Todos</option>
        <option value="today">Hoy</option>
        <option value="7days">Ãšltimos 7 dÃ­as</option>
        <option value="month">Este mes</option>
      </select>
    </div>

    <div id="myKeysList" class="grid grid-cols-1 gap-4"></div>
  </section>

  <script>
    // --- Firebase ConfiguraciÃ³n ---
    const firebaseConfig = {
      apiKey: "AIzaSyAcbewB4Orpx4JyaXq141GgUidJbXUrEnY",
      authDomain: "sociosxit-5f841.firebaseapp.com",
      databaseURL: "https://sociosxit-5f841-default-rtdb.firebaseio.com",
      projectId: "sociosxit-5f841",
      storageBucket: "sociosxit-5f841.firebasestorage.app",
      messagingSenderId: "364183519851",
      appId: "1:364183519851:web:52a5a95d2c57f8f9f5e72e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const pubsRef = db.ref("publications");

    const userNameEl = document.getElementById("userName");
    const userBalanceEl = document.getElementById("userBalance");
    const logoutBtn = document.getElementById("logoutBtn");
    const publicationsContainer = document.getElementById("publicationsContainer");
    const myKeysList = document.getElementById("myKeysList");
    const myKeysContainer = document.getElementById("myKeysContainer");

    // Tabs
    const tabPublicaciones = document.getElementById("tabPublicaciones");
    const tabKeys = document.getElementById("tabKeys");
    tabPublicaciones.onclick = () => showTab("pubs");
    tabKeys.onclick = () => showTab("keys");

    function showTab(tab) {
      if (tab === "pubs") {
        publicationsContainer.classList.remove("hidden");
        myKeysContainer.classList.add("hidden");
        tabPublicaciones.classList.add("active");
        tabKeys.classList.remove("active");
      } else {
        publicationsContainer.classList.add("hidden");
        myKeysContainer.classList.remove("hidden");
        tabPublicaciones.classList.remove("active");
        tabKeys.classList.add("active");
      }
    }

    // --- SesiÃ³n ---
    const currentUser = sessionStorage.getItem("sociosxit_user");
    if (!currentUser) window.location.href = "index.html";
    else {
      userNameEl.textContent = currentUser;
      loadUserBalance(currentUser);
      loadUserPurchases(currentUser);
    }

    logoutBtn.onclick = () => {
      sessionStorage.removeItem("sociosxit_user");
      window.location.href = "index.html";
    };

    // --- Publicaciones ---
    pubsRef.on("value", (snapshot) => {
      publicationsContainer.innerHTML = "";
      const data = snapshot.val();
      if (!data) {
        publicationsContainer.innerHTML = "<p>No hay publicaciones disponibles.</p>";
        return;
      }
      Object.keys(data).forEach(key => {
        const pub = data[key];
        publicationsContainer.prepend(createPublicationElement(pub, key));
      });
    });

    function createPublicationElement(pub, key) {
      const div = document.createElement("div");
      div.className = "card rounded-xl overflow-hidden shadow-lg p-5";
      let mediaHTML = "";

      if (pub.mediaUrl) {
        if (pub.mediaUrl.includes("youtube.com") || pub.mediaUrl.includes("youtu.be")) {
          const videoId = pub.mediaUrl.split('v=')[1] || pub.mediaUrl.split('/').pop();
          mediaHTML = `
            <div class="aspect-w-16 aspect-h-9 mb-4">
              <iframe src="https://www.youtube.com/embed/${videoId}" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen class="w-full h-full rounded-lg"></iframe>
            </div>`;
        } else {
          mediaHTML = `<img src="${pub.mediaUrl}" alt="${pub.title}" class="w-full h-48 object-cover rounded-lg mb-4">`;
        }
      }

      let buttonsHTML = "";
      if (pub.buttons) {
        Object.keys(pub.buttons).forEach(btnKey => {
          const btn = pub.buttons[btnKey];
          const availableKeys = (btn.keys && typeof btn.keys === "string")
            ? btn.keys.split(",").filter(k => k.trim() !== "").length
            : Array.isArray(btn.keys) ? btn.keys.length : 0;

          buttonsHTML += `
            <div class="btn-buy p-4 rounded-lg text-center transition-transform hover:scale-105 cursor-pointer mb-3">
              <div class="text-2xl font-bold">$${btn.price}</div>
              <div class="text-sm font-semibold">${btn.duration}</div>
              <div class="text-xs text-gray-200 mt-1">ðŸ”‘ ${availableKeys} claves disponibles</div>
            </div>`;
        });
      }

      div.innerHTML = `
        ${mediaHTML}
        <h2 class="text-2xl font-bold mb-3">${pub.title}</h2>
        <button class="btn-show w-full py-2 rounded-lg font-semibold" onclick="toggleDetails('${key}')">Mostrar Opciones</button>
        <div id="details-${key}" class="hidden mt-4 space-y-3">${buttonsHTML}</div>
      `;
      return div;
    }

    function toggleDetails(key) {
      document.getElementById(`details-${key}`).classList.toggle("hidden");
    }

    function sanitizeEmail(email) {
      return email.replace(/\./g, "_");
    }

    function loadUserBalance(email) {
      const userKey = sanitizeEmail(email);
      db.ref(`users/${userKey}/balance`).on("value", snap => {
        const balance = snap.val() || 0;
        userBalanceEl.textContent = `$${Number(balance).toFixed(2)}`;
      });
    }

    // --- Historial de keys ---
    function loadUserPurchases(email) {
      const userKey = sanitizeEmail(email);
      const purchasesRef = db.ref(`users/${userKey}/purchases`);
      const searchInput = document.getElementById("searchKeyInput");
      const filterSelect = document.getElementById("filterDateSelect");
      let allPurchases = [];

      purchasesRef.on("value", (snapshot) => {
        const data = snapshot.val();
        if (!data) {
          myKeysList.innerHTML = "<p class='small-muted'>No has comprado claves aÃºn.</p>";
          allPurchases = [];
          return;
        }
        allPurchases = Object.keys(data).map(k => ({ id: k, ...data[k] })).reverse();
        renderPurchases();
      });

      function renderPurchases() {
        const term = (searchInput.value || "").toLowerCase();
        const filter = filterSelect.value;
        const now = new Date();
        myKeysList.innerHTML = "";

        const filtered = allPurchases.filter(it => {
          const title = (it.title || "").toLowerCase();
          const keyVal = (it.key || "").toLowerCase();
          const matchTerm = !term || title.includes(term) || keyVal.includes(term);

          const date = new Date(it.date);
          const diffDays = (now - date) / (1000 * 60 * 60 * 24);
          let matchDate = true;
          if (filter === "today") matchDate = diffDays < 1;
          else if (filter === "7days") matchDate = diffDays <= 7;
          else if (filter === "month") matchDate = date.getMonth() === now.getMonth();

          return matchTerm && matchDate;
        });

        if (!filtered.length) {
          myKeysList.innerHTML = "<p class='small-muted'>No hay resultados para tu bÃºsqueda.</p>";
          return;
        }

        filtered.forEach(it => {
          const div = document.createElement("div");
          div.className = "card rounded-lg p-4 transition-transform hover:scale-[1.01]";
          const date = new Date(it.date).toLocaleString();

          div.innerHTML = `
            <div class="flex flex-col md:flex-row justify-between items-start gap-2">
              <div>
                <div class="text-lg font-semibold">${it.title || "Sin tÃ­tulo"}</div>
                <div class="small-muted">${it.optionText || ""} â€¢ ${it.days || ""}</div>
                <div class="small-muted mt-2">ðŸ“… ${date}</div>
              </div>
              <div class="text-left md:text-right">
                <div class="font-bold text-green-400">$${Number(it.price || 0).toFixed(2)}</div>
                <div class="mono text-sm text-green-300 mt-2 break-all">${it.key}</div>
                <button class="mt-2 bg-white text-blue-900 font-bold py-1 px-3 rounded" onclick="copiarKey('${it.key}')">Copiar</button>
              </div>
            </div>`;
          myKeysList.appendChild(div);
        });
      }

      searchInput.oninput = renderPurchases;
      filterSelect.onchange = renderPurchases;
    }

    function copiarKey(text) {
      navigator.clipboard.writeText(text).then(() => alert("ðŸ”‘ Clave copiada al portapapeles."));
    }

    showTab("pubs");
  </script>
</body>
</html>
